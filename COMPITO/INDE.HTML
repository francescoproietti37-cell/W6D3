<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strive Bookstore</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card-img-top {
        height: 300px;
        object-fit: cover;
      }
      .cart-section {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 20px 0;
        margin-bottom: 20px;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="cart-section sticky-top shadow-sm">
      <div class="container">
        <button
          class="btn btn-primary mb-3"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapseCart"
          aria-expanded="false"
          aria-controls="collapseCart"
        >
          Carrello (<span id="cart-count">0</span>)
        </button>
        <div class="collapse" id="collapseCart">
          <div class="card card-body">
            <h4>Il tuo Carrello</h4>
            <ul id="cart-list" class="list-unstyled"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="container my-4">
      <h1 class="text-center mb-5">La Nostra Libreria</h1>
      <div class="row g-4" id="books-container">
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Endpoint API
      const API_URL = "https://striveschool-api.herokuapp.com/books"

      // Riferimenti al DOM
      const booksContainer = document.getElementById("books-container")
      const cartList = document.getElementById("cart-list")
      const cartCount = document.getElementById("cart-count")

      let cart = JSON.parse(localStorage.getItem("shoppingCart")) || []

      const loadBooks = () => {
        fetch(API_URL)
          .then((response) => response.json())
          .then((books) => {
            booksContainer.innerHTML = ""

            books.forEach((book) => {
              const col = document.createElement("div")
              col.className = "col-12 col-sm-6 col-md-4 col-lg-3"

              // Creazione Card
              col.innerHTML = `
                            <div class="card h-100 shadow-sm">
                                <img src="${book.img}" class="card-img-top" alt="${book.title}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-truncate" title="${book.title}">${book.title}</h5>
                                    <p class="card-text fw-bold">€ ${book.price}</p>
                                    <p class="card-text small text-muted">ASIN: ${book.asin}</p>
                                    
                                    <div class="mt-auto d-flex gap-2">
                                        <button class="btn btn-danger btn-sm w-50 btn-discard">Scarta</button>
                                        <button class="btn btn-success btn-sm w-50 btn-add-cart">Compra ora</button>
                                    </div>
                                </div>
                            </div>
                        `

              const discardBtn = col.querySelector(".btn-discard")
              discardBtn.addEventListener("click", () => {
                col.remove()
              })

              const addCartBtn = col.querySelector(".btn-add-cart")
              addCartBtn.addEventListener("click", () => {
                addToCart(book)
              })

              booksContainer.appendChild(col)
            })
          })
          .catch((error) => {
            console.error("Errore nel caricamento:", error)
            booksContainer.innerHTML = `<div class="alert alert-danger">Errore nel caricamento dei dati.</div>`
          })
      }

      const addToCart = (book) => {
        cart.push(book)
        updateCartStorage()
        renderCart()
      }

      const removeFromCart = (asin) => {
        const index = cart.findIndex((book) => book.asin === asin)
        if (index > -1) {
          cart.splice(index, 1)
        }
        updateCartStorage()
        renderCart()
      }

      const updateCartStorage = () => {
        localStorage.setItem("shoppingCart", JSON.stringify(cart))
        cartCount.innerText = cart.length
      }

      const renderCart = () => {
        cartList.innerHTML = ""

        if (cart.length === 0) {
          cartList.innerHTML =
            '<li class="text-muted">Il carrello è vuoto.</li>'
          return
        }

        cart.forEach((book) => {
          const li = document.createElement("li")
          li.className = "cart-item"
          li.innerHTML = `
                    <span>${book.title} - <strong>€${book.price}</strong></span>
                    <button class="btn btn-outline-danger btn-sm ms-2">Rimuovi</button>
                `

          li.querySelector("button").addEventListener("click", () => {
            removeFromCart(book.asin)
          })

          cartList.appendChild(li)
        })
      }

      window.onload = () => {
        loadBooks()
        renderCart()
        cartCount.innerText = cart.length
      }
    </script>
  </body>
</html>
